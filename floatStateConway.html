<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Field Conway with Flyers</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/2.0.4/p5.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e6e6e6;
            line-height: 1.6;
            padding: 15px;
            overflow-x: hidden;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(30, 30, 50, 0.7);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
        }
        header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #4cc9f0;
        }
        h1 {
            font-size: 28px;
            color: #4cc9f0;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        p {
            font-size: 16px;
            margin-bottom: 15px;
        }
        .canvas-container {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        canvas {
            border: 2px solid #4cc9f0;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(76, 201, 240, 0.3);
        }
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        .control-group {
            background: rgba(22, 36, 71, 0.7);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        h3 {
            color: #4cc9f0;
            margin-bottom: 10px;
            font-size: 18px;
            border-bottom: 1px solid #4cc9f0;
            padding-bottom: 5px;
        }
        .buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        button {
            background: linear-gradient(to bottom, #4361ee, #3a56d4);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        button:active {
            transform: translateY(0);
        }
        .pattern-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .pattern-btn {
            background: rgba(42, 42, 74, 0.8);
            border: 1px solid #4cc9f0;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .pattern-btn:hover {
            background: rgba(58, 58, 90, 0.8);
            transform: scale(1.05);
        }
        .pattern-btn span {
            font-size: 12px;
            display: block;
            margin-top: 5px;
        }
        .slider-container {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #2a2a4a;
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4cc9f0;
            cursor: pointer;
        }
        .value-display {
            font-size: 14px;
            text-align: center;
            margin-top: 5px;
        }
        .toggle-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .toggle-btn {
            background: rgba(42, 42, 74, 0.8);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            border: 1px solid #4cc9f0;
        }
        .toggle-btn.active {
            background: #4361ee;
            box-shadow: 0 0 10px rgba(67, 97, 238, 0.5);
        }
        .palette-display {
            display: flex;
            justify-content: center;
            margin: 10px 0;
            gap: 5px;
        }
        .color-box {
            width: 25px;
            height: 25px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .info {
            background: rgba(22, 36, 71, 0.7);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }
        .info p {
            margin-bottom: 10px;
        }
        .keyboard-shortcuts {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #4cc9f0;
        }
        .shortcut {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Flow Field Conway with Flyers</h1>
            <p>Conway's Game of Life creates a flow field that influences flyer movement. Click cells to toggle states or add patterns.</p>
        </header>

        <div class="canvas-container">
            <div id="canvas"></div>
        </div>

        <div class="controls-grid">
            <div class="control-group">
                <h3>Simulation Controls</h3>
                <div class="buttons">
                    <button id="reset-btn">Reset</button>
                    <button id="random-btn">Randomize</button>
                    <button id="pause-btn">Pause</button>
                    <button id="next-btn">Next Frame</button>
                </div>
                <div class="slider-container">
                    <label for="speed-slider">Simulation Speed:</label>
                    <input type="range" id="speed-slider" min="1" max="30" value="10">
                    <div class="value-display" id="speed-value">10 FPS</div>
                </div>
            </div>

            <div class="control-group">
                <h3>Flyer Controls</h3>
                <div class="slider-container">
                    <label for="flyer-slider">Number of Flyers:</label>
                    <input type="range" id="flyer-slider" min="10" max="500" value="100">
                    <div class="value-display" id="flyer-value">100 Flyers</div>
                </div>
                <div class="slider-container">
                    <label for="force-slider">Flow Force:</label>
                    <input type="range" id="force-slider" min="1" max="100" value="50">
                    <div class="value-display" id="force-value">50%</div>
                </div>
            </div>

            <div class="control-group">
                <h3>Patterns</h3>
                <div class="pattern-buttons">
                    <div class="pattern-btn" id="glider-btn">
                        <svg viewBox="0 0 100 100" width="30" height="30">
                            <rect x="30" y="10" width="20" height="20" fill="#4cc9f0" />
                            <rect x="10" y="30" width="20" height="20" fill="#4cc9f0" />
                            <rect x="30" y="30" width="20" height="20" fill="#4cc9f0" />
                            <rect x="50" y="30" width="20" height="20" fill="#4cc9f0" />
                            <rect x="30" y="50" width="20" height="20" fill="#4cc9f0" />
                        </svg>
                        <span>Glider</span>
                    </div>
                    <div class="pattern-btn" id="blinker-btn">
                        <svg viewBox="0 0 100 100" width="30" height="30">
                            <rect x="10" y="30" width="20" height="20" fill="#4cc9f0" />
                            <rect x="30" y="30" width="20" height="20" fill="#4cc9f0" />
                            <rect x="50" y="30" width="20" height="20" fill="#4cc9f0" />
                        </svg>
                        <span>Blinker</span>
                    </div>
                    <div class="pattern-btn" id="pulsar-btn">
                        <svg viewBox="0 0 100 100" width="30" height="30">
                            <!-- Simplified Pulsar -->
                            <rect x="20" y="10" width="10" height="10" fill="#4cc9f0" />
                            <rect x="20" y="30" width="10" height="10" fill="#4cc9f0" />
                            <rect x="20" y="40" width="10" height="10" fill="#4cc9f0" />
                            <rect x="20" y="60" width="10" height="10" fill="#4cc9f0" />
                            <rect x="20" y="70" width="10" height="10" fill="#4cc9f0" />
                            <rect x="20" y="90" width="10" height="10" fill="#4cc9f0" />
                            <rect x="70" y="10" width="10" height="10" fill="#4cc9f0" />
                            <rect x="70" y="30" width="10" height="10" fill="#4cc9f0" />
                            <rect x="70" y="40" width="10" height="10" fill="#4cc9f0" />
                            <rect x="70" y="60" width="10" height="10" fill="#4cc9f0" />
                            <rect x="70" y="70" width="10" height="10" fill="#4cc9f0" />
                            <rect x="70" y="90" width="10" height="10" fill="#4cc9f0" />
                        </svg>
                        <span>Pulsar</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="control-group">
            <h3>Display Options</h3>
            <div class="toggle-container">
                <div class="toggle-btn active" id="show-flow-btn">Flow Field</div>
                <div class="toggle-btn active" id="show-flyers-btn">Flyers</div>
                <div class="toggle-btn active" id="show-grid-btn">Grid</div>
                <div class="toggle-btn" id="show-trails-btn">Trails</div>
            </div>
            <div class="palette-display">
                <div class="color-box" style="background-color: #03071e;"></div>
                <div class="color-box" style="background-color: #370617;"></div>
                <div class="color-box" style="background-color: #6a040f;"></div>
                <div class="color-box" style="background-color: #9d0208;"></div>
                <div class="color-box" style="background-color: #d00000;"></div>
            </div>
            <div class="value-display">Current Palette: <span id="palette-name">FireGlow</span></div>
        </div>

        <div class="info">
            <p><strong>How it works:</strong> Conway's Game of Life creates a flow field that influences flyer movement. Each cell state affects the flow direction and strength. Flyers (triangles) follow the flow field and change color based on their speed.</p>
            <p><strong>Rules:</strong> Cells with 2-3 live neighbors survive, cells with exactly 3 neighbors become alive, others die. "Live" means state > 0.</p>

            <div class="keyboard-shortcuts">
                <h3>Keyboard Shortcuts</h3>
                <div class="shortcut"><span>Space</span><span>Pause/Resume</span></div>
                <div class="shortcut"><span>R</span><span>Reset Simulation</span></div>
                <div class="shortcut"><span>N</span><span>Next Frame</span></div>
                <div class="shortcut"><span>G</span><span>Place Glider</span></div>
                <div class="shortcut"><span>F</span><span>Toggle Flow Field</span></div>
            </div>
        </div>
    </div>

    <script>
        let grid;
        let nextGrid;
        const rows = 60;
        const cols = 60;
        let cellSize;
        let isPaused = true;
        let currentPaletteIndex = 0;
        let frameRateValue = 10;
        let selectedPattern = null;

        // Flow field vectors
        let flowField;

        // Flyers (previously called boids)
        let flyers = [];
        let flyerCount = 100;
        let flowForce = 0.5;
        let showFlowField = true;
        let showFlyers = true;
        let showGrid = true;
        let showTrails = false;

        // Define color palettes
        const palettes = [
            {"name": "FireGlow", "colors": ["#c61100", "#ff7117", "#ffb73d", "#ffe073", "#fff9bb"]},
            {"name": "Oceanic", "colors": ["#006466", "#065a60", "#0b525b", "#144552", "#1b3a4b"]},
            {"name": "Electric", "colors": ["#ff0a54", "#ff477e", "#ff5c8a", "#ff7096", "#ff85a1"]},
            {"name": "Forest", "colors": ["#386641", "#6a994e", "#a7c957", "#f2e8cf", "#bc4749"]},
            {"name": "Sunset", "colors": ["#03071e", "#370617", "#6a040f", "#9d0208", "#d00000"]}
        ];

        // Pattern definitions
        const patterns = {
            glider: [
                [0, 1, 0],
                [0, 0, 1],
                [1, 1, 1]
            ],
            blinker: [
                [1, 1, 1]
            ],
            pulsar: [
                [0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1],
                [0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0],
                [1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0]
            ]
        };

        // Flyer class
        class Flyer {
            constructor() {
                this.position = createVector(random(width), random(height));
                this.velocity = p5.Vector.random2D();
                this.velocity.setMag(random(1, 3));
                this.acceleration = createVector();
                this.maxForce = 0.3;
                this.maxSpeed = 4;
                this.size = 4;
                this.color = color(255, 255, 255);
            }

            // Apply forces to flyer
            applyForce(force) {
                this.acceleration.add(force);
            }

            // Update flyer position
            update() {
                this.velocity.add(this.acceleration);
                this.velocity.limit(this.maxSpeed);
                this.position.add(this.velocity);
                this.acceleration.mult(0);

                // Wrap around edges
                if (this.position.x > width) this.position.x = 0;
                if (this.position.x < 0) this.position.x = width;
                if (this.position.y > height) this.position.y = 0;
                if (this.position.y < 0) this.position.y = height;
            }

            // Follow the flow field
            followFlowField() {
                const x = floor(this.position.x / cellSize);
                const y = floor(this.position.y / cellSize);

                if (x >= 0 && x < cols && y >= 0 && y < rows) {
                    // Get force from flow field
                    const force = flowField[x][y].copy();

                    // Scale force by flowForce setting
                    force.mult(flowForce);

                    this.applyForce(force);
                }
            }

            // Display flyer as a triangle
            show() {
                push();
                translate(this.position.x, this.position.y);
                rotate(this.velocity.heading() + PI/2);

                // Color based on speed
                const speedColor = map(this.velocity.mag(), 0, this.maxSpeed, 0, 255);
                fill(200, speedColor, 255 - speedColor, 200);
                stroke(50, 200);
                strokeWeight(1);

                // Draw triangle
                triangle(
                    0, -this.size * 2,
                    -this.size, this.size,
                    this.size, this.size
                );
                pop();
            }
        }

        function setup() {
            const canvas = createCanvas(600, 600);
            canvas.parent('canvas');

            cellSize = width / cols;

            initializeGrid();
            initializeFlowField();
            initializeFlyers();

            // Setup buttons
            document.getElementById('reset-btn').addEventListener('click', () => {
                initializeGrid();
                initializeFlowField();
                initializeFlyers();
                document.getElementById('pause-btn').textContent = 'Pause';
                isPaused = true;
            });

            document.getElementById('random-btn').addEventListener('click', () => {
                randomizeGrid();
                updateFlowField();
            });

            document.getElementById('pause-btn').addEventListener('click', togglePause);
            document.getElementById('next-btn').addEventListener('click', nextGeneration);

            // Setup pattern buttons
            document.getElementById('glider-btn').addEventListener('click', () => { selectedPattern = 'glider'; });
            document.getElementById('blinker-btn').addEventListener('click', () => { selectedPattern = 'blinker'; });
            document.getElementById('pulsar-btn').addEventListener('click', () => { selectedPattern = 'pulsar'; });

            // Setup speed slider
            const speedSlider = document.getElementById('speed-slider');
            const speedValue = document.getElementById('speed-value');
            speedSlider.addEventListener('input', function() {
                frameRateValue = parseInt(this.value);
                speedValue.textContent = `${frameRateValue} FPS`;
                frameRate(frameRateValue);
            });

            // Setup flyer count slider
            const flyerSlider = document.getElementById('flyer-slider');
            const flyerValue = document.getElementById('flyer-value');
            flyerSlider.addEventListener('input', function() {
                flyerCount = parseInt(this.value);
                flyerValue.textContent = `${flyerCount} Flyers`;
                initializeFlyers();
            });

            // Setup force slider
            const forceSlider = document.getElementById('force-slider');
            const forceValue = document.getElementById('force-value');
            forceSlider.addEventListener('input', function() {
                flowForce = parseInt(this.value) / 100;
                forceValue.textContent = `${parseInt(this.value)}%`;
            });

            // Setup toggle buttons
            document.getElementById('show-flow-btn').addEventListener('click', function() {
                showFlowField = !showFlowField;
                this.classList.toggle('active');
            });

            document.getElementById('show-flyers-btn').addEventListener('click', function() {
                showFlyers = !showFlyers;
                this.classList.toggle('active');
            });

            document.getElementById('show-grid-btn').addEventListener('click', function() {
                showGrid = !showGrid;
                this.classList.toggle('active');
            });

            document.getElementById('show-trails-btn').addEventListener('click', function() {
                showTrails = !showTrails;
                this.classList.toggle('active');
            });

            frameRate(frameRateValue);
        }

        function initializeGrid() {
            grid = new Array(cols);
            for (let i = 0; i < cols; i++) {
                grid[i] = new Array(rows);
                for (let j = 0; j < rows; j++) {
                    grid[i][j] = 0; // All cells start at state 0 (dead)
                }
            }

            selectedPattern = null;
            updatePaletteDisplay();
        }

        function initializeFlowField() {
            flowField = new Array(cols);
            for (let i = 0; i < cols; i++) {
                flowField[i] = new Array(rows);
                for (let j = 0; j < rows; j++) {
                    // Initialize with random vectors
                    flowField[i][j] = p5.Vector.random2D();
                    flowField[i][j].setMag(0.1);
                }
            }
        }

        function initializeFlyers() {
            flyers = [];
            for (let i = 0; i < flyerCount; i++) {
                flyers.push(new Flyer());
            }
        }

        function randomizeGrid() {
            for (let i = 0; i < cols; i++) {
                for (let j = 0; j < rows; j++) {
                    // Randomly assign one of the five states with higher probability for 0
                    const rand = random();
                    if (rand < 0.7) {
                        grid[i][j] = 0;
                    } else {
                        grid[i][j] = floor(random(1, 5)) * 0.25;
                    }
                }
            }
            updateFlowField();
        }

        function draw() {
            // Handle trails effect
            if (showTrails) {
                fill(0, 0, 0, 25);
                rect(0, 0, width, height);
            } else {
                background(40);
            }

            if (!isPaused) {
                computeNextGeneration();
                updateFlowField();
            }

            if (showGrid) {
                drawGrid();
            }

            if (showFlowField) {
                drawFlowField();
            }

            // Update and draw flyers
            if (showFlyers) {
                for (let flyer of flyers) {
                    flyer.followFlowField();
                    flyer.update();
                    flyer.show();
                }
            }
        }

        function computeNextGeneration() {
            nextGrid = new Array(cols);
            for (let i = 0; i < cols; i++) {
                nextGrid[i] = new Array(rows);
                for (let j = 0; j < rows; j++) {
                    // Apply Conway's Game of Life rules with floating states
                    nextGrid[i][j] = applyRules(i, j);
                }
            }

            grid = nextGrid;
        }

        function updateFlowField() {
            for (let i = 0; i < cols; i++) {
                for (let j = 0; j < rows; j++) {
                    // Flow field vectors are influenced by cell states and their neighbors
                    let angle = 0;

                    if (grid[i][j] > 0) {
                        // Live cells create more organized flow based on state
                        angle = (grid[i][j] * TWO_PI * 2) + (noise(i * 0.1, j * 0.1, frameCount * 0.01) * PI/4);
                    } else {
                        // Dead cells create more random flow
                        angle = noise(i * 0.2, j * 0.2, frameCount * 0.02) * TWO_PI * 4;
                    }

                    // Magnitude based on cell state
                    const mag = map(grid[i][j], 0, 1, 0.05, 0.5);

                    flowField[i][j] = p5.Vector.fromAngle(angle, mag);
                }
            }
        }

        function applyRules(x, y) {
            // Count live neighbors (state > 0)
            let liveNeighbors = countLiveNeighbors(x, y);
            let currentState = grid[x][y];

            // Apply Conway's rules
            if (currentState > 0) {
                // Cell is alive
                if (liveNeighbors < 2 || liveNeighbors > 3) {
                    // Die from underpopulation or overpopulation
                    return 0;
                } else {
                    // Stay alive, but increase state if possible
                    return min(1, currentState + 0.01);
                }
            } else {
                // Cell is dead
                if (liveNeighbors === 3) {
                    // Become alive with the "newborn" state (0.25)
                    return 0.25;
                } else {
                    // Stay dead
                    return 0;
                }
            }
        }

        function countLiveNeighbors(x, y) {
            let count = 0;
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    if (i === 0 && j === 0) continue; // Skip the cell itself

                    let col = (x + i + cols) % cols;
                    let row = (y + j + rows) % rows;

                    if (grid[col][row] > 0) {
                        count++;
                    }
                }
            }
            return count;
        }

        function drawGrid() {
            for (let i = 0; i < cols; i++) {
                for (let j = 0; j < rows; j++) {
                    let state = grid[i][j];
                    let color = getColorForState(state);

                    fill(color);
                    noStroke();
                    rect(i * cellSize, j * cellSize, cellSize, cellSize);
                }
            }
        }

        function drawFlowField() {
            stroke(255, 100);
            for (let i = 0; i < cols; i += 2) {
                for (let j = 0; j < rows; j += 2) {
                    const x = i * cellSize + cellSize / 2;
                    const y = j * cellSize + cellSize / 2;

                    push();
                    translate(x, y);
                    rotate(flowField[i][j].heading());
                    const len = cellSize * 0.8 * flowField[i][j].mag() * 5;
                    line(0, 0, len, 0);
                    pop();
                }
            }
        }

        function getColorForState(state) {
            // Map the float state to a color from the current palette
            if (state === 0) return color(palettes[currentPaletteIndex].colors[0]);

            let index = 1;
            if (state >= 0.25) index = 2;
            if (state >= 0.5) index = 3;
            if (state >= 0.75) index = 4;

            return color(palettes[currentPaletteIndex].colors[index]);
        }

        function mousePressed() {
            if (mouseX > 0 && mouseX < width && mouseY > 0 && mouseY < height) {
                let i = floor(mouseX / cellSize);
                let j = floor(mouseY / cellSize);

                if (selectedPattern) {
                    // Place the selected pattern
                    placePattern(selectedPattern, i, j);
                    // Change palette for new cells
                    currentPaletteIndex = (currentPaletteIndex + 1) % palettes.length;
                    updatePaletteDisplay();
                } else {
                    // Set the clicked cell to the next state
                    let currentState = grid[i][j];
                    grid[i][j] = (currentState + 0.25) % 1.25;
                    if (grid[i][j] === 0.25) {
                        // Change palette for new cells
                        currentPaletteIndex = (currentPaletteIndex + 1) % palettes.length;
                        updatePaletteDisplay();
                    }
                }

                // Update flow field
                updateFlowField();
            }
        }

        function placePattern(patternName, x, y) {
            const pattern = patterns[patternName];
            const patternHeight = pattern.length;
            const patternWidth = pattern[0].length;

            // Center the pattern on the click position
            const startX = x - floor(patternWidth / 2);
            const startY = y - floor(patternHeight / 2);

            for (let i = 0; i < patternHeight; i++) {
                for (let j = 0; j < patternWidth; j++) {
                    const cellX = (startX + j + cols) % cols;
                    const cellY = (startY + i + rows) % rows;

                    if (pattern[i][j] === 1) {
                        grid[cellX][cellY] = 0.25; // Newborn state
                    }
                }
            }
        }

        function updatePaletteDisplay() {
            const paletteBoxes = document.querySelectorAll('.color-box');
            for (let i = 0; i < 5; i++) {
                paletteBoxes[i].style.backgroundColor = palettes[currentPaletteIndex].colors[i];
            }
            document.getElementById('palette-name').textContent = palettes[currentPaletteIndex].name;
        }

        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pause-btn').textContent = isPaused ? 'Resume' : 'Pause';
        }

        function nextGeneration() {
            if (isPaused) {
                computeNextGeneration();
                updateFlowField();
            }
        }

        function keyPressed() {
            if (key === ' ') {
                togglePause();
                return false; // Prevent default behavior
            } else if (key === 'r' || key === 'R') {
                initializeGrid();
                initializeFlowField();
                initializeFlyers();
                document.getElementById('pause-btn').textContent = 'Pause';
                isPaused = true;
            } else if (key === 'n' || key === 'N') {
                nextGeneration();
            } else if (key === 'g' || key === 'G') {
                selectedPattern = 'glider';
            } else if (key === 'f' || key === 'F') {
                showFlowField = !showFlowField;
                document.getElementById('show-flow-btn').classList.toggle('active');
            }
        }
    </script>
</body>
</html>
