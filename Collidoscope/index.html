<!DOCTYPE html>
<html>
<head>
    <title>Audio Collidoscope</title>
</head>
<body>
    <div id="controls">
        <button id="startAudio">Start Audio</button>
        <button id="addParticle">Add Particle</button>
        <input type="range" id="energy" min="0" max="1" step="0.1" value="0.5">
        <label for="energy">Energy</label>
    </div>
    
    <canvas id="visualizer" width="800" height="400"></canvas>
    
    <script>
        class AudioCollidoscope {
            constructor() {
                this.audioContext = null;
                this.particles = [];
                this.isRunning = false;
                
                this.initAudio();
                this.initVisualization();
                this.setupEventListeners();
            }
            
            async initAudio() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Wait for user interaction to start audio
                document.getElementById('startAudio').addEventListener('click', async () => {
                    await this.audioContext.resume();
                    this.isRunning = true;
                    this.startAnimation();
                });
            }
            
            createParticleSound(x, y, velocity, mass) {
                if (!this.isRunning) return;
                
                const now = this.audioContext.currentTime;
                
                // Create collision sound
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                const panner = this.audioContext.createStereoPanner();
                
                // Calculate frequency based on mass and velocity
                const baseFreq = 100 + (mass * 50) + (velocity * 200);
                
                oscillator.type = this.getWaveformForEnergy(velocity);
                oscillator.frequency.setValueAtTime(baseFreq, now);
                
                // Pan based on x position
                panner.pan.setValueAtTime((x / 800) * 2 - 1, now);
                
                // Amplitude envelope
                const amplitude = Math.min(velocity * 0.3, 0.5);
                gainNode.gain.setValueAtTime(amplitude, now);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 2);
                
                // Connect and play
                oscillator.connect(gainNode);
                gainNode.connect(panner);
                panner.connect(this.audioContext.destination);
                
                oscillator.start(now);
                oscillator.stop(now + 2);
            }
            
            getWaveformForEnergy(energy) {
                if (energy < 0.3) return 'sine';
                if (energy < 0.7) return 'triangle';
                return 'sawtooth';
            }
            
            initVisualization() {
                this.canvas = document.getElementById('visualizer');
                this.ctx = this.canvas.getContext('2d');
            }
            
            startAnimation() {
                // Animation loop for visualization
                const animate = () => {
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // Update and draw particles
                    this.particles.forEach((particle, index) => {
                        // Simple physics
                        particle.x += particle.vx;
                        particle.y += particle.vy;
                        
                        // Boundary collision with audio
                        if (particle.x <= 0 || particle.x >= this.canvas.width) {
                            particle.vx = -particle.vx;
                            this.createParticleSound(particle.x, particle.y, 
                                                   Math.abs(particle.vx), particle.mass);
                        }
                        
                        if (particle.y <= 0 || particle.y >= this.canvas.height) {
                            particle.vy = -particle.vy;
                            this.createParticleSound(particle.x, particle.y,
                                                   Math.abs(particle.vy), particle.mass);
                        }
                        
                        // Draw particle
                        this.ctx.beginPath();
                        this.ctx.arc(particle.x, particle.y, particle.mass * 2, 0, Math.PI * 2);
                        this.ctx.fillStyle = `hsl(${particle.mass * 50}, 70%, 60%)`;
                        this.ctx.fill();
                    });
                    
                    requestAnimationFrame(animate);
                };
                
                animate();
            }
            
            setupEventListeners() {
                document.getElementById('addParticle').addEventListener('click', () => {
                    this.particles.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        vx: (Math.random() - 0.5) * 4,
                        vy: (Math.random() - 0.5) * 4,
                        mass: Math.random() * 5 + 1
                    });
                });
            }
        }
        
        // Initialize the collidoscope
        const collidoscope = new AudioCollidoscope();
    </script>
</body>
</html>
