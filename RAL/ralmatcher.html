<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAL Color Matcher with CMYK</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --background-color: #f5f7fa;
            --card-background: #ffffff;
            --text-color: #333333;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .description {
            color: #666;
            max-width: 800px;
            margin: 0 auto;
        }

        .input-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .color-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .input-group {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .color-preview {
            width: 100%;
            height: 80px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .input-row label {
            min-width: 30px;
            font-weight: bold;
        }

        input[type="range"] {
            flex: 1;
        }

        input[type="number"] {
            width: 70px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .hex-input, .cmyk-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            margin-top: 10px;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }

        .tab-button.active {
            border-bottom-color: var(--secondary-color);
            color: var(--secondary-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .results-section {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .color-card {
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: var(--transition);
        }

        .color-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .color-swatch {
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            font-weight: bold;
            flex-direction: column;
            gap: 5px;
        }

        .color-info {
            padding: 15px;
        }

        .color-code {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .color-name {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
        }

        .color-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.8rem;
        }

        .value-group {
            display: flex;
            flex-direction: column;
        }

        .value-label {
            font-weight: bold;
            color: #888;
        }

        .difference {
            margin-top: 5px;
            font-size: 0.8rem;
            color: #888;
            text-align: center;
            padding: 5px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 768px) {
            .color-inputs {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .color-values {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>RAL Color Matcher with CMYK</h1>
            <p class="description">Find the closest RAL colors to your input color. Use RGB, HEX, or CMYK values. Based on the complete RAL Design System Plus with over 1,600 colors.</p>
        </header>

        <section class="input-section">
            <div class="color-inputs">
                <div class="input-group">
                    <h2>Input Color</h2>
                    <div class="color-preview" id="colorPreview">
                        <div>RGB: 120, 120, 120</div>
                        <div>CMYK: 0%, 0%, 0%, 53%</div>
                    </div>
                    
                    <div class="tab-buttons">
                        <button class="tab-button active" data-tab="rgb">RGB/HEX</button>
                        <button class="tab-button" data-tab="cmyk">CMYK</button>
                    </div>
                    
                    <div class="tab-content active" id="rgbTab">
                        <div class="input-row">
                            <label>R:</label>
                            <input type="range" id="redSlider" min="0" max="255" value="120">
                            <input type="number" id="redInput" min="0" max="255" value="120">
                        </div>
                        <div class="input-row">
                            <label>G:</label>
                            <input type="range" id="greenSlider" min="0" max="255" value="120">
                            <input type="number" id="greenInput" min="0" max="255" value="120">
                        </div>
                        <div class="input-row">
                            <label>B:</label>
                            <input type="range" id="blueSlider" min="0" max="255" value="120">
                            <input type="number" id="blueInput" min="0" max="255" value="120">
                        </div>
                        <input type="text" id="hexInput" class="hex-input" placeholder="#787878" value="#787878">
                    </div>
                    
                    <div class="tab-content" id="cmykTab">
                        <div class="input-row">
                            <label>C:</label>
                            <input type="range" id="cyanSlider" min="0" max="100" value="0">
                            <input type="number" id="cyanInput" min="0" max="100" value="0">%
                        </div>
                        <div class="input-row">
                            <label>M:</label>
                            <input type="range" id="magentaSlider" min="0" max="100" value="0">
                            <input type="number" id="magentaInput" min="0" max="100" value="0">%
                        </div>
                        <div class="input-row">
                            <label>Y:</label>
                            <input type="range" id="yellowSlider" min="0" max="100" value="0">
                            <input type="number" id="yellowInput" min="0" max="100" value="0">%
                        </div>
                        <div class="input-row">
                            <label>K:</label>
                            <input type="range" id="blackSlider" min="0" max="100" value="53">
                            <input type="number" id="blackInput" min="0" max="100" value="53">%
                        </div>
                        <input type="text" id="cmykInput" class="cmyk-input" placeholder="0,0,0,53" value="0,0,0,53">
                    </div>
                </div>

                <div class="input-group">
                    <h2>Settings</h2>
                    <div class="input-row">
                        <label for="resultsCount">Number of results:</label>
                        <input type="number" id="resultsCount" min="1" max="50" value="12">
                    </div>
                    <div class="input-row">
                        <label for="language">Language:</label>
                        <select id="language">
                            <option value="en">English</option>
                            <option value="ru">Russian</option>
                        </select>
                    </div>
                    <div class="input-row">
                        <label for="colorSpace">Color difference method:</label>
                        <select id="colorSpace">
                            <option value="rgb">RGB Euclidean</option>
                            <option value="cie76">CIE76 (Lab)</option>
                        </select>
                    </div>
                    <button id="findMatches" style="width: 100%; padding: 10px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">Find Matching Colors</button>
                </div>
            </div>
        </section>

        <section class="results-section">
            <h2>Closest RAL Colors</h2>
            <div class="loading" id="loadingIndicator">Loading color data... This may take a moment.</div>
            <div class="results-grid" id="resultsContainer">
                <!-- Results will be displayed here -->
            </div>
        </section>

        <footer>
            <p>RAL Color Matcher - Based on complete RAL Design System Plus (1,625 colors) | Data sources: 
                <a href="https://yus.github.io/RAL/ral-design-system-plus-farbnamen-en.txt" target="_blank">English names</a>, 
                <a href="https://yus.github.io/RAL/ral-design-system-plus-farbnamen-ru.txt" target="_blank">Russian names</a>, 
                <a href="https://yus.github.io/RAL/comprehensiveRAL.json" target="_blank">JSON data</a>
            </p>
        </footer>
    </div>

    <script>
        // Color data structure
        const colorData = {
            ralColors: [],
            language: 'en',
            colorNames: {
                en: {},
                ru: {}
            },
            loaded: false
        };

        // DOM elements
        const elements = {
            // RGB inputs
            redSlider: document.getElementById('redSlider'),
            redInput: document.getElementById('redInput'),
            greenSlider: document.getElementById('greenSlider'),
            greenInput: document.getElementById('greenInput'),
            blueSlider: document.getElementById('blueSlider'),
            blueInput: document.getElementById('blueInput'),
            hexInput: document.getElementById('hexInput'),
            
            // CMYK inputs
            cyanSlider: document.getElementById('cyanSlider'),
            cyanInput: document.getElementById('cyanInput'),
            magentaSlider: document.getElementById('magentaSlider'),
            magentaInput: document.getElementById('magentaInput'),
            yellowSlider: document.getElementById('yellowSlider'),
            yellowInput: document.getElementById('yellowInput'),
            blackSlider: document.getElementById('blackSlider'),
            blackInput: document.getElementById('blackInput'),
            cmykInput: document.getElementById('cmykInput'),
            
            // Other elements
            colorPreview: document.getElementById('colorPreview'),
            resultsCount: document.getElementById('resultsCount'),
            language: document.getElementById('language'),
            colorSpace: document.getElementById('colorSpace'),
            findMatches: document.getElementById('findMatches'),
            resultsContainer: document.getElementById('resultsContainer'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            
            // Tab elements
            rgbTab: document.getElementById('rgbTab'),
            cmykTab: document.getElementById('cmykTab')
        };

        // Initialize the application
        async function init() {
            setupEventListeners();
            setupTabs();
            await loadColorData();
            updateColorPreview();
            findMatchingColors();
        }

        // Set up tab functionality
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Add active class to clicked button and corresponding content
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab') + 'Tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        // Load complete RAL color data
        async function loadColorData() {
            try {
                elements.loadingIndicator.style.display = 'block';
                elements.resultsContainer.innerHTML = '';
                
                // Load comprehensive RAL data (this contains all 1,625 colors with RGB values)
                const jsonResponse = await fetch('https://yus.github.io/RAL/comprehensiveRAL.json');
                const jsonData = await jsonResponse.json();
                
                // Extract colors from the JSON structure
                if (jsonData.colors && Array.isArray(jsonData.colors)) {
                    colorData.ralColors = jsonData.colors.map(color => {
                        // Ensure we have RGB values
                        if (color.rgb) {
                            return {
                                code: color.code,
                                rgb: color.rgb,
                                // Calculate Lab values for better color difference calculations
                                lab: rgbToLab(color.rgb.r, color.rgb.g, color.rgb.b)
                            };
                        }
                        return null;
                    }).filter(color => color !== null);
                } else {
                    throw new Error('Invalid data structure');
                }
                
                // Load English color names
                const enResponse = await fetch('https://yus.github.io/RAL/ral-design-system-plus-farbnamen-en.txt');
                const enText = await enResponse.text();
                colorData.colorNames.en = parseColorNames(enText);
                
                // Load Russian color names
                const ruResponse = await fetch('https://yus.github.io/RAL/ral-design-system-plus-farbnamen-ru.txt');
                const ruText = await ruResponse.text();
                colorData.colorNames.ru = parseColorNames(ruText);
                
                colorData.loaded = true;
                elements.loadingIndicator.style.display = 'none';
                
                console.log(`Loaded ${colorData.ralColors.length} RAL colors`);
                
            } catch (error) {
                console.error('Error loading color data:', error);
                elements.loadingIndicator.innerHTML = 'Error loading color data. Using limited sample set.';
                
                // Fallback to sample data
                loadSampleData();
                colorData.loaded = true;
                elements.loadingIndicator.style.display = 'none';
            }
        }

        // Parse color names from text format
        function parseColorNames(text) {
            const names = {};
            const lines = text.split('\n');
            
            for (const line of lines) {
                if (line.trim() === '') continue;
                
                const parts = line.split('\t');
                if (parts.length >= 2) {
                    const code = parts[0].trim();
                    const name = parts[1].trim();
                    names[code] = name;
                }
            }
            
            return names;
        }

        // Sample data for fallback (extended)
        function loadSampleData() {
            // Generate a more comprehensive sample set
            colorData.ralColors = [];
            
            // Create samples across the color spectrum
            const hues = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 
                         160, 170, 180, 190, 200, 210, 220, 230, 240, 250, 260, 270, 280, 290, 300, 310, 320, 330, 340, 350];
            const lightness = [15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95];
            const chroma = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90];
            
            let count = 0;
            for (let h = 0; h < hues.length && count < 200; h++) {
                for (let l = 0; l < lightness.length && count < 200; l++) {
                    for (let c = 0; c < chroma.length && count < 200; c++) {
                        if (Math.random() > 0.7) continue; // Skip some to keep sample manageable
                        
                        const hue = hues[h];
                        const light = lightness[l];
                        const chrom = chroma[c];
                        
                        // Convert HLC to RGB (simplified)
                        const rgb = hlcToRgb(hue, light, chrom);
                        
                        if (rgb) {
                            colorData.ralColors.push({
                                code: `RAL ${hue.toString().padStart(3, '0')} ${light} ${chrom}`,
                                rgb: rgb,
                                lab: rgbToLab(rgb.r, rgb.g, rgb.b)
                            });
                            count++;
                        }
                    }
                }
            }
            
            // Sample names for fallback
            colorData.colorNames.en = {};
            colorData.colorNames.ru = {};
            
            colorData.ralColors.forEach(color => {
                colorData.colorNames.en[color.code] = `Sample ${color.code}`;
                colorData.colorNames.ru[color.code] = `Образец ${color.code}`;
            });
        }

        // Simplified HLC to RGB conversion for sample data
        function hlcToRgb(h, l, c) {
            // This is a very simplified conversion for demonstration
            const hue = h / 360;
            const lightness = l / 100;
            const chroma = c / 100;
            
            // Simple conversion - in reality this would be more complex
            const r = Math.min(255, Math.max(0, Math.round((Math.sin(hue * 2 * Math.PI) * chroma + lightness) * 255)));
            const g = Math.min(255, Math.max(0, Math.round((Math.sin((hue + 0.333) * 2 * Math.PI) * chroma + lightness) * 255)));
            const b = Math.min(255, Math.max(0, Math.round((Math.sin((hue + 0.667) * 2 * Math.PI) * chroma + lightness) * 255)));
            
            return { r, g, b };
        }

        // Set up event listeners for user interactions
        function setupEventListeners() {
            // RGB sliders and inputs
            elements.redSlider.addEventListener('input', updateRed);
            elements.redInput.addEventListener('input', updateRed);
            elements.greenSlider.addEventListener('input', updateGreen);
            elements.greenInput.addEventListener('input', updateGreen);
            elements.blueSlider.addEventListener('input', updateBlue);
            elements.blueInput.addEventListener('input', updateBlue);
            
            // Hex input
            elements.hexInput.addEventListener('input', updateFromHex);
            
            // CMYK sliders and inputs
            elements.cyanSlider.addEventListener('input', updateCyan);
            elements.cyanInput.addEventListener('input', updateCyan);
            elements.magentaSlider.addEventListener('input', updateMagenta);
            elements.magentaInput.addEventListener('input', updateMagenta);
            elements.yellowSlider.addEventListener('input', updateYellow);
            elements.yellowInput.addEventListener('input', updateYellow);
            elements.blackSlider.addEventListener('input', updateBlack);
            elements.blackInput.addEventListener('input', updateBlack);
            
            // CMYK text input
            elements.cmykInput.addEventListener('input', updateFromCmyk);
            
            // Find matches button
            elements.findMatches.addEventListener('click', findMatchingColors);
            
            // Language and color space selectors
            elements.language.addEventListener('change', findMatchingColors);
            elements.colorSpace.addEventListener('change', findMatchingColors);
        }

        // RGB update functions
        function updateRed() {
            const value = Math.min(255, Math.max(0, parseInt(elements.redSlider.value) || 0));
            elements.redSlider.value = value;
            elements.redInput.value = value;
            updateColorFromRGB();
        }

        function updateGreen() {
            const value = Math.min(255, Math.max(0, parseInt(elements.greenSlider.value) || 0));
            elements.greenSlider.value = value;
            elements.greenInput.value = value;
            updateColorFromRGB();
        }

        function updateBlue() {
            const value = Math.min(255, Math.max(0, parseInt(elements.blueSlider.value) || 0));
            elements.blueSlider.value = value;
            elements.blueInput.value = value;
            updateColorFromRGB();
        }

        // CMYK update functions
        function updateCyan() {
            const value = Math.min(100, Math.max(0, parseInt(elements.cyanSlider.value) || 0));
            elements.cyanSlider.value = value;
            elements.cyanInput.value = value;
            updateColorFromCMYK();
        }

        function updateMagenta() {
            const value = Math.min(100, Math.max(0, parseInt(elements.magentaSlider.value) || 0));
            elements.magentaSlider.value = value;
            elements.magentaInput.value = value;
            updateColorFromCMYK();
        }

        function updateYellow() {
            const value = Math.min(100, Math.max(0, parseInt(elements.yellowSlider.value) || 0));
            elements.yellowSlider.value = value;
            elements.yellowInput.value = value;
            updateColorFromCMYK();
        }

        function updateBlack() {
            const value = Math.min(100, Math.max(0, parseInt(elements.blackSlider.value) || 0));
            elements.blackSlider.value = value;
            elements.blackInput.value = value;
            updateColorFromCMYK();
        }

        // Update color from RGB values
        function updateColorFromRGB() {
            const r = parseInt(elements.redInput.value);
            const g = parseInt(elements.greenInput.value);
            const b = parseInt(elements.blueInput.value);
            
            // Update hex input
            const hex = rgbToHex(r, g, b);
            elements.hexInput.value = hex;
            
            // Update CMYK values
            const cmyk = rgbToCmyk(r, g, b);
            updateCmykInputs(cmyk);
            
            updateColorPreview();
        }

        // Update color from CMYK values
        function updateColorFromCMYK() {
            const c = parseInt(elements.cyanInput.value) / 100;
            const m = parseInt(elements.magentaInput.value) / 100;
            const y = parseInt(elements.yellowInput.value) / 100;
            const k = parseInt(elements.blackInput.value) / 100;
            
            // Update CMYK text input
            elements.cmykInput.value = `${Math.round(c*100)},${Math.round(m*100)},${Math.round(y*100)},${Math.round(k*100)}`;
            
            // Convert to RGB
            const rgb = cmykToRgb(c, m, y, k);
            updateRgbInputs(rgb);
            
            updateColorPreview();
        }

        // Update from hex input
        function updateFromHex() {
            const hex = elements.hexInput.value.replace('#', '');
            
            if (hex.length === 3 || hex.length === 6) {
                const rgb = hexToRgb(hex);
                if (rgb) {
                    updateRgbInputs(rgb);
                    
                    // Update CMYK
                    const cmyk = rgbToCmyk(rgb.r, rgb.g, rgb.b);
                    updateCmykInputs(cmyk);
                    
                    updateColorPreview();
                }
            }
        }

        // Update from CMYK input
        function updateFromCmyk() {
            const cmykStr = elements.cmykInput.value;
            const parts = cmykStr.split(',').map(part => parseInt(part.trim()));
            
            if (parts.length === 4 && parts.every(p => !isNaN(p) && p >= 0 && p <= 100)) {
                const [c, m, y, k] = parts;
                elements.cyanInput.value = c;
                elements.cyanSlider.value = c;
                elements.magentaInput.value = m;
                elements.magentaSlider.value = m;
                elements.yellowInput.value = y;
                elements.yellowSlider.value = y;
                elements.blackInput.value = k;
                elements.blackSlider.value = k;
                
                updateColorFromCMYK();
            }
        }

        // Update RGB inputs
        function updateRgbInputs(rgb) {
            elements.redSlider.value = rgb.r;
            elements.redInput.value = rgb.r;
            elements.greenSlider.value = rgb.g;
            elements.greenInput.value = rgb.g;
            elements.blueSlider.value = rgb.b;
            elements.blueInput.value = rgb.b;
            
            elements.hexInput.value = rgbToHex(rgb.r, rgb.g, rgb.b);
        }

        // Update CMYK inputs
        function updateCmykInputs(cmyk) {
            elements.cyanInput.value = Math.round(cmyk.c * 100);
            elements.cyanSlider.value = Math.round(cmyk.c * 100);
            elements.magentaInput.value = Math.round(cmyk.m * 100);
            elements.magentaSlider.value = Math.round(cmyk.m * 100);
            elements.yellowInput.value = Math.round(cmyk.y * 100);
            elements.yellowSlider.value = Math.round(cmyk.y * 100);
            elements.blackInput.value = Math.round(cmyk.k * 100);
            elements.blackSlider.value = Math.round(cmyk.k * 100);
            
            elements.cmykInput.value = `${Math.round(cmyk.c * 100)},${Math.round(cmyk.m * 100)},${Math.round(cmyk.y * 100)},${Math.round(cmyk.k * 100)}`;
        }

        // Update color preview
        function updateColorPreview() {
            const r = parseInt(elements.redInput.value);
            const g = parseInt(elements.greenInput.value);
            const b = parseInt(elements.blueInput.value);
            
            const cmyk = rgbToCmyk(r, g, b);
            
            elements.colorPreview.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
            
            // Adjust text color for better contrast
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            elements.colorPreview.style.color = brightness > 128 ? 'black' : 'white';
            elements.colorPreview.innerHTML = `
                <div>RGB: ${r}, ${g}, ${b}</div>
                <div>CMYK: ${Math.round(cmyk.c * 100)}%, ${Math.round(cmyk.m * 100)}%, ${Math.round(cmyk.y * 100)}%, ${Math.round(cmyk.k * 100)}%</div>
            `;
        }

        // Color conversion functions
        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }

        function hexToRgb(hex) {
            if (hex.length === 3) {
                hex = hex.split('').map(x => x + x).join('');
            }
            
            const result = /^([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function rgbToCmyk(r, g, b) {
            if (r === 0 && g === 0 && b === 0) {
                return { c: 0, m: 0, y: 0, k: 1 };
            }
            
            const rPrime = r / 255;
            const gPrime = g / 255;
            const bPrime = b / 255;
            
            const k = 1 - Math.max(rPrime, gPrime, bPrime);
            const c = (1 - rPrime - k) / (1 - k);
            const m = (1 - gPrime - k) / (1 - k);
            const y = (1 - bPrime - k) / (1 - k);
            
            return {
                c: c || 0,
                m: m || 0,
                y: y || 0,
                k: k || 0
            };
        }

        function cmykToRgb(c, m, y, k) {
            const r = 255 * (1 - c) * (1 - k);
            const g = 255 * (1 - m) * (1 - k);
            const b = 255 * (1 - y) * (1 - k);
            
            return {
                r: Math.round(r),
                g: Math.round(g),
                b: Math.round(b)
            };
        }

        // RGB to Lab conversion for better color difference calculations
        function rgbToLab(r, g, b) {
            // First convert RGB to XYZ
            let rLinear = r / 255;
            let gLinear = g / 255;
            let bLinear = b / 255;
            
            rLinear = rLinear > 0.04045 ? Math.pow((rLinear + 0.055) / 1.055, 2.4) : rLinear / 12.92;
            gLinear = gLinear > 0.04045 ? Math.pow((gLinear + 0.055) / 1.055, 2.4) : gLinear / 12.92;
            bLinear = bLinear > 0.04045 ? Math.pow((bLinear + 0.055) / 1.055, 2.4) : bLinear / 12.92;
            
            rLinear *= 100;
            gLinear *= 100;
            bLinear *= 100;
            
            // Convert to XYZ using D65 reference white
            const x = rLinear * 0.4124 + gLinear * 0.3576 + bLinear * 0.1805;
            const y = rLinear * 0.2126 + gLinear * 0.7152 + bLinear * 0.0722;
            const z = rLinear * 0.0193 + gLinear * 0.1192 + bLinear * 0.9505;
            
            // Convert XYZ to Lab
            const xRef = 95.047;
            const yRef = 100.000;
            const zRef = 108.883;
            
            let xNormalized = x / xRef;
            let yNormalized = y / yRef;
            let zNormalized = z / zRef;
            
            xNormalized = xNormalized > 0.008856 ? Math.pow(xNormalized, 1/3) : (7.787 * xNormalized) + (16/116);
            yNormalized = yNormalized > 0.008856 ? Math.pow(yNormalized, 1/3) : (7.787 * yNormalized) + (16/116);
            zNormalized = zNormalized > 0.008856 ? Math.pow(zNormalized, 1/3) : (7.787 * zNormalized) + (16/116);
            
            const l = (116 * yNormalized) - 16;
            const a = 500 * (xNormalized - yNormalized);
            const bLab = 200 * (yNormalized - zNormalized);
            
            return { l, a, b: bLab };
        }

        // Color difference calculations
        function colorDifferenceRgb(rgb1, rgb2) {
            const rDiff = rgb1.r - rgb2.r;
            const gDiff = rgb1.g - rgb2.g;
            const bDiff = rgb1.b - rgb2.b;
            
            return Math.sqrt(rDiff * rDiff + gDiff * gDiff + bDiff * bDiff);
        }

        function colorDifferenceLab(lab1, lab2) {
            const lDiff = lab1.l - lab2.l;
            const aDiff = lab1.a - lab2.a;
            const bDiff = lab1.b - lab2.b;
            
            return Math.sqrt(lDiff * lDiff + aDiff * aDiff + bDiff * bDiff);
        }

        // Find matching colors
        function findMatchingColors() {
            if (!colorData.loaded) {
                elements.resultsContainer.innerHTML = '<div class="loading">Still loading color data...</div>';
                return;
            }
            
            const inputRgb = {
                r: parseInt(elements.redInput.value),
                g: parseInt(elements.greenInput.value),
                b: parseInt(elements.blueInput.value)
            };
            
            const inputLab = rgbToLab(inputRgb.r, inputRgb.g, inputRgb.b);
            const resultsCount = parseInt(elements.resultsCount.value) || 12;
            const language = elements.language.value;
            const colorSpace = elements.colorSpace.value;
            
            // Calculate differences for all RAL colors
            const colorsWithDifferences = colorData.ralColors.map(color => {
                let difference;
                if (colorSpace === 'cie76' && color.lab) {
                    difference = colorDifferenceLab(inputLab, color.lab);
                } else {
                    difference = colorDifferenceRgb(inputRgb, color.rgb);
                }
                
                return {
                    ...color,
                    difference: difference,
                    cmyk: rgbToCmyk(color.rgb.r, color.rgb.g, color.rgb.b)
                };
            });
            
            // Sort by difference (ascending)
            colorsWithDifferences.sort((a, b) => a.difference - b.difference);
            
            // Take top results
            const topMatches = colorsWithDifferences.slice(0, resultsCount);
            
            // Display results
            displayResults(topMatches, language);
        }

        // Display results in the UI
        function displayResults(matches, language) {
            elements.resultsContainer.innerHTML = '';
            
            if (matches.length === 0) {
                elements.resultsContainer.innerHTML = '<p>No matching colors found.</p>';
                return;
            }
            
            matches.forEach(match => {
                const colorCard = document.createElement('div');
                colorCard.className = 'color-card';
                
                const colorSwatch = document.createElement('div');
                colorSwatch.className = 'color-swatch';
                colorSwatch.style.backgroundColor = `rgb(${match.rgb.r}, ${match.rgb.g}, ${match.rgb.b})`;
                
                // Adjust text color for contrast
                const brightness = (match.rgb.r * 299 + match.rgb.g * 587 + match.rgb.b * 114) / 1000;
                colorSwatch.style.color = brightness > 128 ? 'black' : 'white';
                
                colorSwatch.innerHTML = `
                    <div>${match.code}</div>
                    <div style="font-size: 0.8rem;">RGB: ${match.rgb.r}, ${match.rgb.g}, ${match.rgb.b}</div>
                `;
                
                const colorInfo = document.createElement('div');
                colorInfo.className = 'color-info';
                
                const colorCode = document.createElement('div');
                colorCode.className = 'color-code';
                colorCode.textContent = match.code;
                
                const colorName = document.createElement('div');
                colorName.className = 'color-name';
                colorName.textContent = colorData.colorNames[language][match.code] || 'Name not available';
                
                const colorValues = document.createElement('div');
                colorValues.className = 'color-values';
                
                const rgbValues = document.createElement('div');
                rgbValues.className = 'value-group';
                rgbValues.innerHTML = `
                    <div class="value-label">RGB</div>
                    <div>${match.rgb.r}, ${match.rgb.g}, ${match.rgb.b}</div>
                `;
                
                const cmykValues = document.createElement('div');
                cmykValues.className = 'value-group';
                cmykValues.innerHTML = `
                    <div class="value-label">CMYK</div>
                    <div>${Math.round(match.cmyk.c * 100)}%, ${Math.round(match.cmyk.m * 100)}%, ${Math.round(match.cmyk.y * 100)}%, ${Math.round(match.cmyk.k * 100)}%</div>
                `;
                
                colorValues.appendChild(rgbValues);
                colorValues.appendChild(cmykValues);
                
                const difference = document.createElement('div');
                difference.className = 'difference';
                difference.textContent = `Color difference: ${match.difference.toFixed(2)}`;
                
                colorInfo.appendChild(colorCode);
                colorInfo.appendChild(colorName);
                colorInfo.appendChild(colorValues);
                colorInfo.appendChild(difference);
                
                colorCard.appendChild(colorSwatch);
                colorCard.appendChild(colorInfo);
                
                elements.resultsContainer.appendChild(colorCard);
            });
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
