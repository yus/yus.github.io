<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAL Color Matcher with CMYK</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --background-color: #f5f7fa;
            --card-background: #ffffff;
            --text-color: #333333;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .description {
            color: #666;
            max-width: 800px;
            margin: 0 auto;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .nav-tab {
            padding: 12px 24px;
            background: var(--card-background);
            border: 2px solid var(--secondary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: var(--transition);
        }

        .nav-tab.active {
            background: var(--secondary-color);
            color: white;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .input-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .color-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .input-group {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .color-preview {
            width: 100%;
            height: 80px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .preview-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            text-align: center;
        }

        .preview-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .preview-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .input-row label {
            min-width: 30px;
            font-weight: bold;
        }

        input[type="range"] {
            flex: 1;
        }

        input[type="number"] {
            width: 70px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .hex-input, .cmyk-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            margin-top: 10px;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }

        .tab-button.active {
            border-bottom-color: var(--secondary-color);
            color: var(--secondary-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .results-section {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .color-card {
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: var(--transition);
            cursor: pointer;
        }

        .color-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .color-swatch {
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            font-weight: bold;
            flex-direction: column;
            gap: 5px;
        }

        .color-info {
            padding: 15px;
        }

        .color-code {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .color-name {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
            font-style: italic;
        }

        .color-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.8rem;
        }

        .value-group {
            display: flex;
            flex-direction: column;
        }

        .value-label {
            font-weight: bold;
            color: #888;
        }

        .difference {
            margin-top: 5px;
            font-size: 0.8rem;
            color: #888;
            text-align: center;
            padding: 5px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .difference-low {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .difference-medium {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .difference-high {
            background-color: #ffebee;
            color: #c62828;
        }

        /* Catalog Page Styles */
        .catalog-controls {
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .catalog-search {
            flex: 1;
            min-width: 250px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .hue-filter {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .hue-button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .hue-button.active {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .catalog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .catalog-card {
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: var(--transition);
        }

        .catalog-card.highlighted {
            animation: pulse 2s infinite;
            border: 3px solid var(--secondary-color);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
        }

        .catalog-swatch {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            font-weight: bold;
        }

        .catalog-info {
            padding: 10px;
            font-size: 0.85rem;
        }

        .catalog-code {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .section-header {
            background: var(--primary-color);
            color: white;
            padding: 15px 20px;
            margin: 30px 0 15px 0;
            border-radius: var(--border-radius);
            font-size: 1.2rem;
        }

        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--secondary-color);
            color: white;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow);
            display: none;
        }

        .view-catalog-link {
            display: inline-block;
            margin-top: 10px;
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: bold;
        }

        .view-catalog-link:hover {
            text-decoration: underline;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .settings-group {
            margin-bottom: 15px;
        }

        .settings-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .slider-value {
            display: inline-block;
            width: 50px;
            text-align: right;
            font-weight: bold;
            color: var(--secondary-color);
        }

        @media (max-width: 768px) {
            .color-inputs {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .color-values {
                grid-template-columns: 1fr;
            }
            
            .preview-values {
                grid-template-columns: 1fr;
            }
            
            .catalog-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .catalog-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>RAL Color Matcher & Catalog</h1>
            <p class="description">Find the closest RAL colors or browse the complete RAL Design System Plus catalog with over 1,600 colors.</p>
        </header>

        <div class="nav-tabs">
            <div class="nav-tab active" data-page="matcher">Color Matcher</div>
            <div class="nav-tab" data-page="catalog">Full Catalog</div>
        </div>

        <!-- Color Matcher Page -->
        <div class="page active" id="matcherPage">
            <section class="input-section">
                <div class="color-inputs">
                    <div class="input-group">
                        <h2>Input Color</h2>
                        <div class="color-preview" id="colorPreview">
                            <div class="preview-values">
                                <div class="preview-group">
                                    <div class="preview-label">RGB</div>
                                    <div>120, 120, 120</div>
                                </div>
                                <div class="preview-group">
                                    <div class="preview-label">CMYK</div>
                                    <div>0%, 0%, 0%, 53%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-buttons">
                            <button class="tab-button active" data-tab="rgb">RGB/HEX</button>
                            <button class="tab-button" data-tab="cmyk">CMYK</button>
                        </div>
                        
                        <div class="tab-content active" id="rgbTab">
                            <div class="input-row">
                                <label>R:</label>
                                <input type="range" id="redSlider" min="0" max="255" value="120">
                                <input type="number" id="redInput" min="0" max="255" value="120">
                            </div>
                            <div class="input-row">
                                <label>G:</label>
                                <input type="range" id="greenSlider" min="0" max="255" value="120">
                                <input type="number" id="greenInput" min="0" max="255" value="120">
                            </div>
                            <div class="input-row">
                                <label>B:</label>
                                <input type="range" id="blueSlider" min="0" max="255" value="120">
                                <input type="number" id="blueInput" min="0" max="255" value="120">
                            </div>
                            <input type="text" id="hexInput" class="hex-input" placeholder="#787878" value="#787878">
                        </div>
                        
                        <div class="tab-content" id="cmykTab">
                            <div class="input-row">
                                <label>C:</label>
                                <input type="range" id="cyanSlider" min="0" max="100" value="0">
                                <input type="number" id="cyanInput" min="0" max="100" value="0">%
                            </div>
                            <div class="input-row">
                                <label>M:</label>
                                <input type="range" id="magentaSlider" min="0" max="100" value="0">
                                <input type="number" id="magentaInput" min="0" max="100" value="0">%
                            </div>
                            <div class="input-row">
                                <label>Y:</label>
                                <input type="range" id="yellowSlider" min="0" max="100" value="0">
                                <input type="number" id="yellowInput" min="0" max="100" value="0">%
                            </div>
                            <div class="input-row">
                                <label>K:</label>
                                <input type="range" id="blackSlider" min="0" max="100" value="53">
                                <input type="number" id="blackInput" min="0" max="100" value="53">%
                            </div>
                            <input type="text" id="cmykInput" class="cmyk-input" placeholder="0,0,0,53" value="0,0,0,53">
                        </div>
                    </div>

                    <div class="input-group">
                        <h2>Settings</h2>
                        
                        <div class="settings-group">
                            <label for="resultsCount">
                                Number of results: <span class="slider-value" id="resultsCountValue">12</span>
                            </label>
                            <input type="range" id="resultsCount" min="1" max="50" value="12">
                        </div>
                        
                        <div class="settings-group">
                            <label for="maxDifference">
                                Max color difference: <span class="slider-value" id="maxDifferenceValue">100</span>
                            </label>
                            <input type="range" id="maxDifference" min="1" max="200" value="100">
                        </div>
                        
                        <div class="settings-group">
                            <label for="language">Language:</label>
                            <select id="language">
                                <option value="en">English</option>
                                <option value="ru">Russian</option>
                            </select>
                        </div>
                        
                        <div class="settings-group">
                            <label for="colorSpace">Color difference method:</label>
                            <select id="colorSpace">
                                <option value="rgb">RGB Euclidean</option>
                                <option value="cie76">CIE76 (Lab)</option>
                            </select>
                        </div>
                        
                        <button id="findMatches" style="width: 100%; padding: 10px; background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">Find Matching Colors</button>
                    </div>
                </div>
            </section>

            <section class="results-section">
                <h2>Closest RAL Colors</h2>
                <a href="#" class="view-catalog-link" id="viewCatalogLink" style="display: none;">View this color in full catalog →</a>
                <div class="loading" id="loadingIndicator">Loading color data... This may take a moment.</div>
                <div class="results-grid" id="resultsContainer">
                    <!-- Results will be displayed here -->
                </div>
            </section>
        </div>

        <!-- Catalog Page -->
        <div class="page" id="catalogPage">
            <div class="catalog-controls">
                <input type="text" id="catalogSearch" class="catalog-search" placeholder="Search by RAL code or color name...">
                <div class="hue-filter">
                    <div class="hue-button active" data-hue="all">All Colors</div>
                    <div class="hue-button" data-hue="red">Reds</div>
                    <div class="hue-button" data-hue="orange">Oranges</div>
                    <div class="hue-button" data-hue="yellow">Yellows</div>
                    <div class="hue-button" data-hue="green">Greens</div>
                    <div class="hue-button" data-hue="blue">Blues</div>
                    <div class="hue-button" data-hue="purple">Purples</div>
                    <div class="hue-button" data-hue="neutral">Neutrals</div>
                </div>
            </div>

            <div class="loading" id="catalogLoading">Loading catalog...</div>
            <div id="catalogContainer">
                <!-- Catalog will be displayed here -->
            </div>
        </div>

        <div class="back-to-top" id="backToTop">↑</div>

        <footer>
            <p>RAL Color Matcher & Catalog - Based on complete RAL Design System Plus (1,625 colors) | Data sources: 
                <a href="https://yus.github.io/RAL/ral-design-system-plus-farbnamen-en.txt" target="_blank">English names</a>, 
                <a href="https://yus.github.io/RAL/ral-design-system-plus-farbnamen-ru.txt" target="_blank">Russian names</a>, 
                <a href="https://yus.github.io/RAL/comprehensiveRAL.json" target="_blank">JSON data</a>
            </p>
        </footer>
    </div>

    <script>
        // Color data structure
        const colorData = {
            ralColors: [],
            language: 'en',
            colorNames: {
                en: {},
                ru: {}
            },
            loaded: false,
            currentHighlight: null
        };

        // DOM elements
        const elements = {
            // Navigation
            navTabs: document.querySelectorAll('.nav-tab'),
            pages: document.querySelectorAll('.page'),
            backToTop: document.getElementById('backToTop'),

            // Matcher page elements
            redSlider: document.getElementById('redSlider'),
            redInput: document.getElementById('redInput'),
            greenSlider: document.getElementById('greenSlider'),
            greenInput: document.getElementById('greenInput'),
            blueSlider: document.getElementById('blueSlider'),
            blueInput: document.getElementById('blueInput'),
            hexInput: document.getElementById('hexInput'),
            cyanSlider: document.getElementById('cyanSlider'),
            cyanInput: document.getElementById('cyanInput'),
            magentaSlider: document.getElementById('magentaSlider'),
            magentaInput: document.getElementById('magentaInput'),
            yellowSlider: document.getElementById('yellowSlider'),
            yellowInput: document.getElementById('yellowInput'),
            blackSlider: document.getElementById('blackSlider'),
            blackInput: document.getElementById('blackInput'),
            cmykInput: document.getElementById('cmykInput'),
            resultsCount: document.getElementById('resultsCount'),
            resultsCountValue: document.getElementById('resultsCountValue'),
            maxDifference: document.getElementById('maxDifference'),
            maxDifferenceValue: document.getElementById('maxDifferenceValue'),
            language: document.getElementById('language'),
            colorSpace: document.getElementById('colorSpace'),
            colorPreview: document.getElementById('colorPreview'),
            findMatches: document.getElementById('findMatches'),
            resultsContainer: document.getElementById('resultsContainer'),
            loadingIndicator: document.getElementById('loadingIndicator'),
            viewCatalogLink: document.getElementById('viewCatalogLink'),
            rgbTab: document.getElementById('rgbTab'),
            cmykTab: document.getElementById('cmykTab'),

            // Catalog page elements
            catalogSearch: document.getElementById('catalogSearch'),
            catalogLoading: document.getElementById('catalogLoading'),
            catalogContainer: document.getElementById('catalogContainer'),
            hueButtons: document.querySelectorAll('.hue-button')
        };

        // Initialize the application
        async function init() {
            setupNavigation();
            setupEventListeners();
            setupTabs();
            await loadColorData();
            updateColorPreview();
            findMatchingColors();
        }

        // Set up navigation between pages
        function setupNavigation() {
            elements.navTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const pageId = tab.getAttribute('data-page') + 'Page';
                    
                    // Update active tab
                    elements.navTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show corresponding page
                    elements.pages.forEach(page => page.classList.remove('active'));
                    document.getElementById(pageId).classList.add('active');
                    
                    // Load catalog if needed
                    if (pageId === 'catalogPage' && colorData.loaded) {
                        displayCatalog();
                    }
                });
            });

            // Back to top button
            elements.backToTop.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            window.addEventListener('scroll', () => {
                elements.backToTop.style.display = window.scrollY > 500 ? 'block' : 'none';
            });
        }

        // Set up tab functionality
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab') + 'Tab';
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        // Load complete RAL color data with actual names
        async function loadColorData() {
            try {
                elements.loadingIndicator.style.display = 'block';
                elements.catalogLoading.style.display = 'block';
                
                // Load comprehensive RAL data
                const jsonResponse = await fetch('https://yus.github.io/RAL/comprehensiveRAL.json');
                const jsonData = await jsonResponse.json();
                
                if (jsonData.colors && Array.isArray(jsonData.colors)) {
                    colorData.ralColors = jsonData.colors.map(color => {
                        if (color.rgb) {
                            return {
                                code: color.code,
                                rgb: color.rgb,
                                lab: rgbToLab(color.rgb.r, color.rgb.g, color.rgb.b),
                                hue: getHueCategory(color.rgb.r, color.rgb.g, color.rgb.b)
                            };
                        }
                        return null;
                    }).filter(color => color !== null);
                } else {
                    throw new Error('Invalid data structure');
                }
                
                // Load English color names
                const enResponse = await fetch('https://yus.github.io/RAL/ral-design-system-plus-farbnamen-en.txt');
                const enText = await enResponse.text();
                colorData.colorNames.en = parseColorNames(enText);
                
                // Load Russian color names
                const ruResponse = await fetch('https://yus.github.io/RAL/ral-design-system-plus-farbnamen-ru.txt');
                const ruText = await ruResponse.text();
                colorData.colorNames.ru = parseColorNames(ruText);
                
                colorData.loaded = true;
                elements.loadingIndicator.style.display = 'none';
                elements.catalogLoading.style.display = 'none';
                
                console.log(`Loaded ${colorData.ralColors.length} RAL colors with ${Object.keys(colorData.colorNames.en).length} English names`);
                
            } catch (error) {
                console.error('Error loading color data:', error);
                elements.loadingIndicator.innerHTML = 'Error loading color data. Using limited sample set.';
                elements.catalogLoading.innerHTML = 'Error loading catalog data. Using limited sample set.';
                
                loadSampleDataWithNames();
                colorData.loaded = true;
                elements.loadingIndicator.style.display = 'none';
                elements.catalogLoading.style.display = 'none';
            }
        }

        // Get hue category for filtering
        function getHueCategory(r, g, b) {
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            const delta = max - min;
            
            if (delta === 0) return 'neutral';
            
            let hue;
            if (max === r) hue = ((g - b) / delta) % 6;
            else if (max === g) hue = (b - r) / delta + 2;
            else hue = (r - g) / delta + 4;
            
            hue = Math.round(hue * 60);
            if (hue < 0) hue += 360;
            
            if (hue >= 330 || hue < 30) return 'red';
            if (hue >= 30 && hue < 60) return 'orange';
            if (hue >= 60 && hue < 90) return 'yellow';
            if (hue >= 90 && hue < 150) return 'green';
            if (hue >= 150 && hue < 210) return 'blue';
            if (hue >= 210 && hue < 270) return 'purple';
            if (hue >= 270 && hue < 330) return 'purple';
            return 'neutral';
        }

        // Parse color names from text format
        function parseColorNames(text) {
            const names = {};
            const lines = text.split('\n');
            
            for (const line of lines) {
                if (line.trim() === '') continue;
                
                const parts = line.split('\t');
                if (parts.length >= 2) {
                    const code = parts[0].trim();
                    const name = parts[1].trim();
                    if (name && name !== 'undefined') {
                        names[code] = name;
                    }
                }
            }
            
            return names;
        }

        // Sample data with beautiful color names for fallback
        function loadSampleDataWithNames() {
            // ... (same sample data implementation as before)
            // Keeping it concise for the response
            colorData.ralColors = [
                { code: "RAL 000 15 00", rgb: { r: 0, g: 0, b: 0 }, lab: rgbToLab(0, 0, 0) },
                { code: "RAL 010 30 44", rgb: { r: 125, g: 57, b: 71 }, lab: rgbToLab(125, 57, 71) },
                { code: "RAL 030 50 60", rgb: { r: 191, g: 98, b: 56 }, lab: rgbToLab(191, 98, 56) },
                { code: "RAL 050 50 78", rgb: { r: 255, g: 132, b: 0 }, lab: rgbToLab(255, 132, 0) },
                { code: "RAL 060 70 70", rgb: { r: 255, g: 175, b: 69 }, lab: rgbToLab(255, 175, 69) },
                { code: "RAL 075 70 30", rgb: { r: 181, g: 178, b: 130 }, lab: rgbToLab(181, 178, 130) },
                { code: "RAL 095 90 10", rgb: { r: 230, g: 229, b: 207 }, lab: rgbToLab(230, 229, 207) },
                { code: "RAL 110 60 40", rgb: { r: 138, g: 162, b: 120 }, lab: rgbToLab(138, 162, 120) },
                { code: "RAL 120 50 40", rgb: { r: 81, g: 130, b: 107 }, lab: rgbToLab(81, 130, 107) },
                { code: "RAL 160 50 45", rgb: { r: 62, g: 140, b: 125 }, lab: rgbToLab(62, 140, 125) },
                { code: "RAL 200 40 35", rgb: { r: 42, g: 108, b: 140 }, lab: rgbToLab(42, 108, 140) },
                { code: "RAL 240 40 35", rgb: { r: 42, g: 92, b: 142 }, lab: rgbToLab(42, 92, 142) },
                { code: "RAL 280 40 35", rgb: { r: 58, g: 71, b: 142 }, lab: rgbToLab(58, 71, 142) },
                { code: "RAL 310 50 35", rgb: { r: 130, g: 102, b: 142 }, lab: rgbToLab(130, 102, 142) },
                { code: "RAL 340 40 45", rgb: { r: 142, g: 56, b: 107 }, lab: rgbToLab(142, 56, 107) },
                { code: "RAL 350 40 45", rgb: { r: 142, g: 56, b: 81 }, lab: rgbToLab(142, 56, 81) }
            ];
            
            // Beautiful color names
            colorData.colorNames.en = {
                "RAL 000 15 00": "Jet Black",
                "RAL 010 30 44": "Deep Claret",
                "RAL 030 50 60": "Fiery Orange",
                "RAL 050 50 78": "Sunburst Yellow",
                "RAL 060 70 70": "Golden Apricot",
                "RAL 075 70 30": "Pistachio Cream",
                "RAL 095 90 10": "Pearl White",
                "RAL 110 60 40": "Sage Green",
                "RAL 120 50 40": "Forest Depth",
                "RAL 160 50 45": "Ocean Teal",
                "RAL 200 40 35": "Marine Blue",
                "RAL 240 40 35": "Cobalt Night",
                "RAL 280 40 35": "Royal Velvet",
                "RAL 310 50 35": "Misty Lilac",
                "RAL 340 40 45": "Magenta Bloom",
                "RAL 350 40 45": "Berry Wine"
            };
            
            colorData.colorNames.ru = {
                "RAL 000 15 00": "Глубокий черный",
                "RAL 010 30 44": "Темно-бордовый",
                "RAL 030 50 60": "Огненно-оранжевый",
                "RAL 050 50 78": "Солнечно-желтый",
                "RAL 060 70 70": "Золотисто-абрикосовый",
                "RAL 075 70 30": "Фисташковый крем",
                "RAL 095 90 10": "Жемчужно-белый",
                "RAL 110 60 40": "Шалфейно-зеленый",
                "RAL 120 50 40": "Лесная глушь",
                "RAL 160 50 45": "Океанская бирюза",
                "RAL 200 40 35": "Морская синева",
                "RAL 240 40 35": "Кобальтовая ночь",
                "RAL 280 40 35": "Королевский бархат",
                "RAL 310 50 35": "Туманная сирень",
                "RAL 340 40 45": "Малиновый цвет",
                "RAL 350 40 45": "Ягодное вино"
            };
        }

        // Set up event listeners
        function setupEventListeners() {
            // RGB inputs
            elements.redSlider.addEventListener('input', updateRed);
            elements.redInput.addEventListener('input', updateRed);
            elements.greenSlider.addEventListener('input', updateGreen);
            elements.greenInput.addEventListener('input', updateGreen);
            elements.blueSlider.addEventListener('input', updateBlue);
            elements.blueInput.addEventListener('input', updateBlue);
            elements.hexInput.addEventListener('input', updateFromHex);
            
            // CMYK inputs
            elements.cyanSlider.addEventListener('input', updateCyan);
            elements.cyanInput.addEventListener('input', updateCyan);
            elements.magentaSlider.addEventListener('input', updateMagenta);
            elements.magentaInput.addEventListener('input', updateMagenta);
            elements.yellowSlider.addEventListener('input', updateYellow);
            elements.yellowInput.addEventListener('input', updateYellow);
            elements.blackSlider.addEventListener('input', updateBlack);
            elements.blackInput.addEventListener('input', updateBlack);
            elements.cmykInput.addEventListener('input', updateFromCmyk);
            
            // Settings
            elements.resultsCount.addEventListener('input', updateResultsCount);
            elements.maxDifference.addEventListener('input', updateMaxDifference);
            elements.findMatches.addEventListener('click', findMatchingColors);
            elements.language.addEventListener('change', findMatchingColors);
            elements.colorSpace.addEventListener('change', findMatchingColors);
            
            // Catalog
            elements.catalogSearch.addEventListener('input', filterCatalog);
            elements.hueButtons.forEach(button => {
                button.addEventListener('click', () => {
                    elements.hueButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    filterCatalog();
                });
            });
        }

        // Update settings
        function updateResultsCount() {
            elements.resultsCountValue.textContent = elements.resultsCount.value;
        }

        function updateMaxDifference() {
            elements.maxDifferenceValue.textContent = elements.maxDifference.value;
        }

        // RGB update functions
        function updateRed() {
            const value = Math.min(255, Math.max(0, parseInt(elements.redSlider.value) || 0));
            elements.redSlider.value = value;
            elements.redInput.value = value;
            updateColorFromRGB();
        }

        function updateGreen() {
            const value = Math.min(255, Math.max(0, parseInt(elements.greenSlider.value) || 0));
            elements.greenSlider.value = value;
            elements.greenInput.value = value;
            updateColorFromRGB();
        }

        function updateBlue() {
            const value = Math.min(255, Math.max(0, parseInt(elements.blueSlider.value) || 0));
            elements.blueSlider.value = value;
            elements.blueInput.value = value;
            updateColorFromRGB();
        }

        // CMYK update functions
        function updateCyan() {
            const value = Math.min(100, Math.max(0, parseInt(elements.cyanSlider.value) || 0));
            elements.cyanSlider.value = value;
            elements.cyanInput.value = value;
            updateColorFromCMYK();
        }

        function updateMagenta() {
            const value = Math.min(100, Math.max(0, parseInt(elements.magentaSlider.value) || 0));
            elements.magentaSlider.value = value;
            elements.magentaInput.value = value;
            updateColorFromCMYK();
        }

        function updateYellow() {
            const value = Math.min(100, Math.max(0, parseInt(elements.yellowSlider.value) || 0));
            elements.yellowSlider.value = value;
            elements.yellowInput.value = value;
            updateColorFromCMYK();
        }

        function updateBlack() {
            const value = Math.min(100, Math.max(0, parseInt(elements.blackSlider.value) || 0));
            elements.blackSlider.value = value;
            elements.blackInput.value = value;
            updateColorFromCMYK();
        }

        // Color conversion and update functions
        function updateColorFromRGB() {
            const r = parseInt(elements.redInput.value);
            const g = parseInt(elements.greenInput.value);
            const b = parseInt(elements.blueInput.value);
            
            const hex = rgbToHex(r, g, b);
            elements.hexInput.value = hex;
            
            const cmyk = rgbToCmyk(r, g, b);
            updateCmykInputs(cmyk);
            
            updateColorPreview();
        }

        function updateColorFromCMYK() {
            const c = parseInt(elements.cyanInput.value) / 100;
            const m = parseInt(elements.magentaInput.value) / 100;
            const y = parseInt(elements.yellowInput.value) / 100;
            const k = parseInt(elements.blackInput.value) / 100;
            
            elements.cmykInput.value = `${Math.round(c*100)},${Math.round(m*100)},${Math.round(y*100)},${Math.round(k*100)}`;
            
            const rgb = cmykToRgb(c, m, y, k);
            updateRgbInputs(rgb);
            
            updateColorPreview();
        }

        function updateFromHex() {
            const hex = elements.hexInput.value.replace('#', '');
            
            if (hex.length === 3 || hex.length === 6) {
                const rgb = hexToRgb(hex);
                if (rgb) {
                    updateRgbInputs(rgb);
                    const cmyk = rgbToCmyk(rgb.r, rgb.g, rgb.b);
                    updateCmykInputs(cmyk);
                    updateColorPreview();
                }
            }
        }

        function updateFromCmyk() {
            const cmykStr = elements.cmykInput.value;
            const parts = cmykStr.split(',').map(part => parseInt(part.trim()));
            
            if (parts.length === 4 && parts.every(p => !isNaN(p) && p >= 0 && p <= 100)) {
                const [c, m, y, k] = parts;
                elements.cyanInput.value = c;
                elements.cyanSlider.value = c;
                elements.magentaInput.value = m;
                elements.magentaSlider.value = m;
                elements.yellowInput.value = y;
                elements.yellowSlider.value = y;
                elements.blackInput.value = k;
                elements.blackSlider.value = k;
                
                updateColorFromCMYK();
            }
        }

        function updateRgbInputs(rgb) {
            elements.redSlider.value = rgb.r;
            elements.redInput.value = rgb.r;
            elements.greenSlider.value = rgb.g;
            elements.greenInput.value = rgb.g;
            elements.blueSlider.value = rgb.b;
            elements.blueInput.value = rgb.b;
            elements.hexInput.value = rgbToHex(rgb.r, rgb.g, rgb.b);
        }

        function updateCmykInputs(cmyk) {
            elements.cyanInput.value = Math.round(cmyk.c * 100);
            elements.cyanSlider.value = Math.round(cmyk.c * 100);
            elements.magentaInput.value = Math.round(cmyk.m * 100);
            elements.magentaSlider.value = Math.round(cmyk.m * 100);
            elements.yellowInput.value = Math.round(cmyk.y * 100);
            elements.yellowSlider.value = Math.round(cmyk.y * 100);
            elements.blackInput.value = Math.round(cmyk.k * 100);
            elements.blackSlider.value = Math.round(cmyk.k * 100);
            elements.cmykInput.value = `${Math.round(cmyk.c * 100)},${Math.round(cmyk.m * 100)},${Math.round(cmyk.y * 100)},${Math.round(cmyk.k * 100)}`;
        }

        function updateColorPreview() {
            const r = parseInt(elements.redInput.value);
            const g = parseInt(elements.greenInput.value);
            const b = parseInt(elements.blueInput.value);
            const cmyk = rgbToCmyk(r, g, b);
            
            elements.colorPreview.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            elements.colorPreview.style.color = brightness > 128 ? 'black' : 'white';
            
            elements.colorPreview.innerHTML = `
                <div class="preview-values">
                    <div class="preview-group">
                        <div class="preview-label">RGB</div>
                        <div>${r}, ${g}, ${b}</div>
                    </div>
                    <div class="preview-group">
                        <div class="preview-label">CMYK</div>
                        <div>${Math.round(cmyk.c * 100)}%, ${Math.round(cmyk.m * 100)}%, ${Math.round(cmyk.y * 100)}%, ${Math.round(cmyk.k * 100)}%</div>
                    </div>
                </div>
            `;
        }

        // Color conversion functions (same as before)
        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }

        function hexToRgb(hex) {
            if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
            const result = /^([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function rgbToCmyk(r, g, b) {
            if (r === 0 && g === 0 && b === 0) return { c: 0, m: 0, y: 0, k: 1 };
            const rPrime = r / 255, gPrime = g / 255, bPrime = b / 255;
            const k = 1 - Math.max(rPrime, gPrime, bPrime);
            return {
                c: (1 - rPrime - k) / (1 - k) || 0,
                m: (1 - gPrime - k) / (1 - k) || 0,
                y: (1 - bPrime - k) / (1 - k) || 0,
                k: k || 0
            };
        }

        function cmykToRgb(c, m, y, k) {
            return {
                r: Math.round(255 * (1 - c) * (1 - k)),
                g: Math.round(255 * (1 - m) * (1 - k)),
                b: Math.round(255 * (1 - y) * (1 - k))
            };
        }

        function rgbToLab(r, g, b) {
            // Implementation same as previous versions
            let rLinear = r / 255, gLinear = g / 255, bLinear = b / 255;
            rLinear = rLinear > 0.04045 ? Math.pow((rLinear + 0.055) / 1.055, 2.4) : rLinear / 12.92;
            gLinear = gLinear > 0.04045 ? Math.pow((gLinear + 0.055) / 1.055, 2.4) : gLinear / 12.92;
            bLinear = bLinear > 0.04045 ? Math.pow((bLinear + 0.055) / 1.055, 2.4) : bLinear / 12.92;
            rLinear *= 100; gLinear *= 100; bLinear *= 100;
            const x = rLinear * 0.4124 + gLinear * 0.3576 + bLinear * 0.1805;
            const y = rLinear * 0.2126 + gLinear * 0.7152 + bLinear * 0.0722;
            const z = rLinear * 0.0193 + gLinear * 0.1192 + bLinear * 0.9505;
            const xRef = 95.047, yRef = 100.000, zRef = 108.883;
            let xNormalized = x / xRef, yNormalized = y / yRef, zNormalized = z / zRef;
            xNormalized = xNormalized > 0.008856 ? Math.pow(xNormalized, 1/3) : (7.787 * xNormalized) + (16/116);
            yNormalized = yNormalized > 0.008856 ? Math.pow(yNormalized, 1/3) : (7.787 * yNormalized) + (16/116);
            zNormalized = zNormalized > 0.008856 ? Math.pow(zNormalized, 1/3) : (7.787 * zNormalized) + (16/116);
            return {
                l: (116 * yNormalized) - 16,
                a: 500 * (xNormalized - yNormalized),
                b: 200 * (yNormalized - zNormalized)
            };
        }

        // Color matching functions
        function colorDifferenceRgb(rgb1, rgb2) {
            const rDiff = rgb1.r - rgb2.r, gDiff = rgb1.g - rgb2.g, bDiff = rgb1.b - rgb2.b;
            return Math.sqrt(rDiff * rDiff + gDiff * gDiff + bDiff * bDiff);
        }

        function colorDifferenceLab(lab1, lab2) {
            const lDiff = lab1.l - lab2.l, aDiff = lab1.a - lab2.a, bDiff = lab1.b - lab2.b;
            return Math.sqrt(lDiff * lDiff + aDiff * aDiff + bDiff * bDiff);
        }

        function findMatchingColors() {
            if (!colorData.loaded) {
                elements.resultsContainer.innerHTML = '<div class="loading">Still loading color data...</div>';
                return;
            }
            
            const inputRgb = {
                r: parseInt(elements.redInput.value),
                g: parseInt(elements.greenInput.value),
                b: parseInt(elements.blueInput.value)
            };
            
            const inputLab = rgbToLab(inputRgb.r, inputRgb.g, inputRgb.b);
            const resultsCount = parseInt(elements.resultsCount.value) || 12;
            const maxDifference = parseInt(elements.maxDifference.value) || 100;
            const language = elements.language.value;
            const colorSpace = elements.colorSpace.value;
            
            const colorsWithDifferences = colorData.ralColors.map(color => {
                let difference = colorSpace === 'cie76' && color.lab ? 
                    colorDifferenceLab(inputLab, color.lab) : 
                    colorDifferenceRgb(inputRgb, color.rgb);
                
                return {
                    ...color,
                    difference: difference,
                    cmyk: rgbToCmyk(color.rgb.r, color.rgb.g, color.rgb.b)
                };
            }).filter(color => color.difference <= maxDifference);
            
            colorsWithDifferences.sort((a, b) => a.difference - b.difference);
            const topMatches = colorsWithDifferences.slice(0, resultsCount);
            
            displayResults(topMatches, language);
            
            // Show catalog link for closest match
            if (topMatches.length > 0) {
                elements.viewCatalogLink.style.display = 'inline-block';
                elements.viewCatalogLink.onclick = (e) => {
                    e.preventDefault();
                    highlightAndShowInCatalog(topMatches[0].code);
                };
            } else {
                elements.viewCatalogLink.style.display = 'none';
            }
        }

        function displayResults(matches, language) {
            elements.resultsContainer.innerHTML = '';
            
            if (matches.length === 0) {
                elements.resultsContainer.innerHTML = '<p>No matching colors found within the specified difference threshold.</p>';
                return;
            }
            
            matches.forEach(match => {
                const colorCard = document.createElement('div');
                colorCard.className = 'color-card';
                colorCard.addEventListener('click', () => highlightAndShowInCatalog(match.code));
                
                const colorSwatch = document.createElement('div');
                colorSwatch.className = 'color-swatch';
                colorSwatch.style.backgroundColor = `rgb(${match.rgb.r}, ${match.rgb.g}, ${match.rgb.b})`;
                
                const brightness = (match.rgb.r * 299 + match.rgb.g * 587 + match.rgb.b * 114) / 1000;
                colorSwatch.style.color = brightness > 128 ? 'black' : 'white';
                colorSwatch.innerHTML = `
                    <div>${match.code}</div>
                    <div style="font-size: 0.8rem;">RGB: ${match.rgb.r}, ${match.rgb.g}, ${match.rgb.b}</div>
                `;
                
                const colorInfo = document.createElement('div');
                colorInfo.className = 'color-info';
                
                const colorCode = document.createElement('div');
                colorCode.className = 'color-code';
                colorCode.textContent = match.code;
                
                const colorName = document.createElement('div');
                colorName.className = 'color-name';
                const actualName = colorData.colorNames[language][match.code];
                colorName.textContent = actualName || 'No name available';
                if (!actualName) colorName.style.color = '#999';
                
                const colorValues = document.createElement('div');
                colorValues.className = 'color-values';
                colorValues.innerHTML = `
                    <div class="value-group">
                        <div class="value-label">RGB</div>
                        <div>${match.rgb.r}, ${match.rgb.g}, ${match.rgb.b}</div>
                    </div>
                    <div class="value-group">
                        <div class="value-label">CMYK</div>
                        <div>${Math.round(match.cmyk.c * 100)}%, ${Math.round(match.cmyk.m * 100)}%, ${Math.round(match.cmyk.y * 100)}%, ${Math.round(match.cmyk.k * 100)}%</div>
                    </div>
                `;
                
                const difference = document.createElement('div');
                difference.className = 'difference';
                if (match.difference < 30) difference.classList.add('difference-low');
                else if (match.difference < 70) difference.classList.add('difference-medium');
                else difference.classList.add('difference-high');
                difference.textContent = `Color difference: ${match.difference.toFixed(2)}`;
                
                colorInfo.appendChild(colorCode);
                colorInfo.appendChild(colorName);
                colorInfo.appendChild(colorValues);
                colorInfo.appendChild(difference);
                
                colorCard.appendChild(colorSwatch);
                colorCard.appendChild(colorInfo);
                elements.resultsContainer.appendChild(colorCard);
            });
        }

        // Catalog functions
        function displayCatalog() {
            if (!colorData.loaded) return;
            
            const language = elements.language.value;
            const hueCategories = {
                red: [], orange: [], yellow: [], green: [], blue: [], purple: [], neutral: []
            };
            
            // Sort colors by hue category
            colorData.ralColors.forEach(color => {
                if (hueCategories[color.hue]) {
                    hueCategories[color.hue].push(color);
                }
            });
            
            // Sort each category by lightness
            Object.keys(hueCategories).forEach(hue => {
                hueCategories[hue].sort((a, b) => {
                    const lightnessA = a.lab ? a.lab.l : 0;
                    const lightnessB = b.lab ? b.lab.l : 0;
                    return lightnessB - lightnessA; // Light to dark
                });
            });
            
            elements.catalogContainer.innerHTML = '';
            
            // Display each category
            const categoryOrder = ['red', 'orange', 'yellow', 'green', 'blue', 'purple', 'neutral'];
            categoryOrder.forEach(hue => {
                if (hueCategories[hue].length === 0) return;
                
                const section = document.createElement('div');
                section.id = `section-${hue}`;
                
                const header = document.createElement('div');
                header.className = 'section-header';
                header.textContent = `${hue.charAt(0).toUpperCase() + hue.slice(1)} Colors (${hueCategories[hue].length})`;
                section.appendChild(header);
                
                const grid = document.createElement('div');
                grid.className = 'catalog-grid';
                
                hueCategories[hue].forEach(color => {
                    const card = createCatalogCard(color, language);
                    grid.appendChild(card);
                });
                
                section.appendChild(grid);
                elements.catalogContainer.appendChild(section);
            });
            
            // Re-apply highlight if needed
            if (colorData.currentHighlight) {
                setTimeout(() => highlightColorInCatalog(colorData.currentHighlight), 100);
            }
        }

        function createCatalogCard(color, language) {
            const card = document.createElement('div');
            card.className = 'catalog-card';
            card.id = `color-${color.code.replace(/\s+/g, '-')}`;
            
            const swatch = document.createElement('div');
            swatch.className = 'catalog-swatch';
            swatch.style.backgroundColor = `rgb(${color.rgb.r}, ${color.rgb.g}, ${color.rgb.b})`;
            
            const brightness = (color.rgb.r * 299 + color.rgb.g * 587 + color.rgb.b * 114) / 1000;
            swatch.style.color = brightness > 128 ? 'black' : 'white';
            swatch.textContent = color.code;
            
            const info = document.createElement('div');
            info.className = 'catalog-info';
            
            const code = document.createElement('div');
            code.className = 'catalog-code';
            code.textContent = color.code;
            
            const name = document.createElement('div');
            name.textContent = colorData.colorNames[language][color.code] || '';
            name.style.fontSize = '0.8rem';
            name.style.color = '#666';
            name.style.fontStyle = 'italic';
            
            info.appendChild(code);
            info.appendChild(name);
            card.appendChild(swatch);
            card.appendChild(info);
            
            return card;
        }

        function filterCatalog() {
            const searchTerm = elements.catalogSearch.value.toLowerCase();
            const activeHue = document.querySelector('.hue-button.active').getAttribute('data-hue');
            
            document.querySelectorAll('.catalog-card').forEach(card => {
                const code = card.querySelector('.catalog-code').textContent.toLowerCase();
                const name = card.querySelector('div:last-child').textContent.toLowerCase();
                const hue = card.closest('.section-header') ? 
                    card.closest('.section-header').textContent.toLowerCase().split(' ')[0] : '';
                
                const matchesSearch = !searchTerm || code.includes(searchTerm) || name.includes(searchTerm);
                const matchesHue = activeHue === 'all' || hue === activeHue;
                
                card.style.display = matchesSearch && matchesHue ? 'block' : 'none';
            });
            
            // Hide empty sections
            document.querySelectorAll('.section-header').forEach(header => {
                const section = header.nextElementSibling;
                const visibleCards = section.querySelectorAll('.catalog-card[style=""]').length + 
                                   section.querySelectorAll('.catalog-card:not([style])').length;
                header.style.display = visibleCards > 0 ? 'block' : 'none';
                section.style.display = visibleCards > 0 ? 'grid' : 'none';
            });
        }

        function highlightAndShowInCatalog(colorCode) {
            // Switch to catalog page
            elements.navTabs.forEach(tab => tab.classList.remove('active'));
            document.querySelector('.nav-tab[data-page="catalog"]').classList.add('active');
            elements.pages.forEach(page => page.classList.remove('active'));
            elements.catalogPage.classList.add('active');
            
            // Load catalog if not already loaded
            if (elements.catalogContainer.innerHTML === '') {
                displayCatalog();
            }
            
            // Highlight the color
            highlightColorInCatalog(colorCode);
        }

        function highlightColorInCatalog(colorCode) {
            // Remove previous highlight
            document.querySelectorAll('.catalog-card.highlighted').forEach(card => {
                card.classList.remove('highlighted');
            });
            
            // Add new highlight
            const cardId = `color-${colorCode.replace(/\s+/g, '-')}`;
            const card = document.getElementById(cardId);
            
            if (card) {
                card.classList.add('highlighted');
                colorData.currentHighlight = colorCode;
                
                // Scroll to the card
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Also ensure the section is visible
                const section = card.closest('.catalog-grid').previousElementSibling;
                if (section) {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
